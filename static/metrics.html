<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetFlow Metrics & Charts</title>
    <link rel="icon" href="data:,">
    <script src="js/htmx.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/highcharts.js"></script>
    <script src="js/exporting.js"></script>
    <script src="js/export-data.js"></script>
    <script src="js/accessibility.js"></script>
    <script src="js/drilldown.js"></script>
    <script src="js/sankey.js"></script>
    <style>
        :root { --col-w: 260px; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7f7f9; }
        header { padding: 12px 16px; background: #1f2937; color: #fff; display: flex; align-items: center; gap: 12px; }
        header h1 { font-size: 18px; margin: 0; }
        .container { display: grid; grid-template-columns: var(--col-w) var(--col-w) 1fr; gap: 0; min-height: calc(100vh - 52px); }
        .col { border-right: 1px solid #e5e7eb; background: #fff; }
        .col h3 { margin: 0; padding: 12px 14px; font-size: 13px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; }
        .panel { padding: 10px 12px; }
        ul.nav { list-style: none; margin: 0; padding: 0; }
        ul.nav li { padding: 8px 6px; border-bottom: 1px solid #f0f0f0; font-size: 12px; cursor: pointer; }
        ul.nav li:hover { background: #f9fafb; }
        .main { padding: 12px; overflow: auto; }
        .filters { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: end; margin-bottom: 10px; }
        label { font-size: 12px; color: #374151; display: block; margin-bottom: 4px; }
        input[type="datetime-local"], select { padding: 6px 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; }
        button { padding: 7px 12px; font-size: 12px; font-weight: 600; color: #fff; background: #2563eb; border: 0; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .htmx-indicator { display: none; margin-left: 8px; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .chart { min-height: 320px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px; }
        @media (min-width: 1200px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
<header>
    <h1>NetFlow Metrics & Charts</h1>
    <span class="htmx-indicator">Loading…</span>
</header>
<div class="container">
    <!-- Exporters column -->
    <aside class="col">
        <h3>Exporters</h3>
        <div class="panel">
            <ul class="nav" id="exporters_div"
                hx-get="/api/v1/exporters/list"
                hx-trigger="load"
                hx-target="#exporters_div"
                hx-swap="innerHTML"
                hx-indicator=".htmx-indicator">
                <li>Loading exporters…</li>
            </ul>
        </div>
    </aside>

    <!-- Interfaces column -->
    <aside class="col">
        <h3>Interfaces</h3>
        <div class="panel">
            <ul class="nav" id="interfaces_div">
                <li>Select an exporter to load interfaces…</li>
            </ul>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main">
        <div class="filters">
            <div>
                <label for="start-dt">Start</label>
                <input id="start-dt" type="datetime-local" step="300">
            </div>
            <div>
                <label for="end-dt">End</label>
                <input id="end-dt" type="datetime-local" step="300">
            </div>
            <div>
                <button id="apply-range" disabled title="Pick interface first">Apply Range</button>
                <span class="htmx-indicator">Updating…</span>
            </div>
        </div>

        <div id="body">
            <div class="charts-grid">
                <div class="chart" style="display:flex;align-items:center;justify-content:center;color:#9ca3af">Select an interface to load charts…</div>
            </div>
        </div>
    </main>
</div>

<script>
// Track current selection from the interfaces list to build the body URL
let current = { exporter: null, iface: null };

// The interfaces list items generated by backend already include
// hx-post="./api/v1/body/{exporter}/{interface}" hx-target="#body"
// We hook clicks to remember the current selection and enable the Apply button.
document.addEventListener('click', function (e) {
  const li = e.target.closest('li');
  if (!li) return;
  // Exporters list items have id exporter.ID and hx-post to interfaces
  if (li.parentElement && li.parentElement.id === 'interfaces_div') {
    // Parse exporter/interface from the li's hx-post in the DOM if present
    // But list items already point body endpoint; capture by reading attribute
    const hxPost = li.getAttribute('hx-post') || '';
    // Expected: ./api/v1/body/{exporter}/{interface}
    const m = hxPost.match(/\/api\/v1\/body\/([^\/]+)\/(\d+)/);
    if (m) {
      current.exporter = m[1];
      current.iface = m[2];
      document.getElementById('apply-range').disabled = false;
    }
  }
}, true);

function toEpochSecondsLocal(dtStr){
  if (!dtStr) return null;
  const d = new Date(dtStr);
  if (isNaN(d)) return null;
  return Math.floor(d.getTime() / 1000);
}

// Apply Range builds the URL /api/v1/body/{exporter}/{interface}/{start}/{end}
// and posts via htmx to update #body as per project conventions.
document.getElementById('apply-range').addEventListener('click', function(){
  if (!current.exporter || !current.iface) return;
  const s = toEpochSecondsLocal(document.getElementById('start-dt').value);
  const e = toEpochSecondsLocal(document.getElementById('end-dt').value);
  let url = `/api/v1/body/${current.exporter}/${current.iface}`;
  if (s && e) { url += `/${s}/${e}`; }
  htmx.ajax('POST', url, { target: '#body', swap: 'innerHTML' });
});

// Highcharts responsiveness and exporting defaults
if (window.Highcharts) {
  Highcharts.setOptions({
    time: { useUTC: false },
    lang: { thousandsSep: ',', numericSymbols: null }
  });
}
</script>
</body>
</html>
